<!doctype html>
<html lang="en">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=1024" />
    <meta name="apple-mobile-web-app-capable" content="yes" />
    <title>VT Code Camp 2013 | Centralized Application Configuration with Apache ZooKeeper</title>

    <meta name="description" content="Presentation for VT Code Camp 2013 on Centralized Application Configuration via Apache ZooKeeper" />
    <meta name="author" content="Jonathan Pearlin" />

    <link href='http://fonts.googleapis.com/css?family=Droid+Sans' rel='stylesheet' type='text/css'>
    <link href='http://fonts.googleapis.com/css?family=Droid+Sans:700,400' rel='stylesheet' type='text/css'>
    <link href="css/impress.css" rel="stylesheet" />
    <link href="css/impressConsole.css" rel="stylesheet" />
    <link rel="shortcut icon" href="images/favicon.ico" />
    <link rel="apple-touch-icon" href="images/apple-touch-icon.png" />
</head>
<body class="impress-not-supported">
    <div class="fallback-message">
        <p>Your browser <b>doesn't support the features required</b> by impress.js, so you are presented with a simplified version of this presentation.</p>
        <p>For the best experience please use the latest <b>Chrome</b>, <b>Safari</b> or <b>Firefox</b> browser.</p>
    </div>
    <div id="impress">
        <div id="start" class="step">
            <h1>Centralized Configuration with Apache ZooKeeper</h1>
            <div style="position:absolute;border:0;width:100%;margin-top:200px;">
                <div style="float:right;text-align:right;font-family:Droid Sans;font-size:20px;color:white">
                    <div>Jonathan Pearlin</div>
                    <div>Technical Lead</div>
                    <div>
                        <img src='images/ddclogo.png' style="width:40%;height:40%"/>
                    </div>
                </div>
            </div>
            <div class="notes">
                <ul>
                    <li>Welcome</li>
                    <li>I'm here to talk about a centralized configuration solution that we built @ Dealer.com here in Burlington</li>
                    <li>In this talk, I am going to talk about our rationale for building this service, as well as the technical details behind it</li>
                    <li>But, before we start, let me introduce myself a bit</li>
                </ul>
            </div>
        </div>
        <div id="step2" class="step slide">
            <h3>about me</h3>
            <div>
                <ul>
                    <li>Technical Lead @ Dealer.com</li>
                    <li>10+ years of Java development experience</li>
                    <li>Contributor to the Grails Framework</li>
                    <li>Lived in MA, VA, CA and VT</li>
                </ul>
                <img style="float:right;" src="images/robot_devil.png" />
            </div>
        </div>
        <div id="step3" class="step slide">
            <img style="width:100%;height:100%" src="images/doc_brown.png" />
            <div class="notes">
                <ul>
                    <li>If only this were true...</li>
                    <li>Configuration is a necessity of non-trivial applications, especially in an enterprise software environment.</li>
                    <li>The more complex the system or the more complex the environment, the more critical configuration becomes.</li>
                    <li>However, despite being critical to the success of software development, configuration is often something that is hard to get right.</li>
                </ul>
            </div>
        </div>
        <div id="step4" class="step slide">
            <h3>problem</h3>
            <div>
                <span>I want to configure my application</span>
            </div>
            <div class="notes">
                <ul>
                    <li>I think that we can all relate to this problem</li>
                    <li>Applications start out simple, but eventually we need to be able to change values at runtime based on factors such as environment or which server they run on, etc</li>
                </ul>
            </div>
        </div>
        <div id="step5" class="step slide">
            <h3>problem</h3>
            <div>
                <span>I want to make configuration changes to my application without re-deploying</span>
            </div>
            <div class="notes">
                <ul>
                    <li>I should be able to make a configuration change and either restart my application or have it pick it up at runtime</li>
                    <li>Things can go wrong if I need to re-build and re-deploy just for a configuration change</li>
                </ul>
            </div>
        </div>
        <div id="step6" class="step slide">
            <h3>problem</h3>
            <div>
                <span>I want to be able to spin up a new instance of an application without having to duplicate its configuration</span>
            </div>
            <div class="notes">
                <ul>
                    <li>I should be able to spin up a new VM and install my application without worrying about making sure I got the configuration right for the target environment</li>
                    <li>I really want to avoid mistakes made when copying configuration between applications</li>
                </ul>
            </div>
        </div>
        <div id="step7" class="step slide">
            <h3>problem</h3>
            <div>
                <span>I want configuration consistency between application instances and different applications</span>
            </div>
            <div class="notes">
                <ul>
                    <li>Just like with the previous problem, I want to avoid copy and paste mistakes</li>
                    <li>Hopefully eliminate communication mistakes where one app owner has to tell another what to put in their configuration</li>
                </ul>
            </div>
        </div>
        <div id="step8" class="step slide">
            <h3>problem</h3>
            <div>
                <span>I want to avoid plain-text passwords in my configuration files</span>
            </div>
            <div class="notes">
                <ul>
                    <li>Because friends don’t let friends store plain-text passwords in configuration files checked into source control.</li>
                </ul>
            </div>
        </div>
        <div id="step9" class="step slide">
            <h3>our solution</h3>
            <div>
                <span>centralized, hierarchical configuration management organized by environment, data center and application</span>
            </div>
            <div class="notes">
                <ul>
                    <li>Configuration stored in one, centralized location
                        <ul>
                            <li>No longer stored in each application’s source repository</li>
                        </ul>
                    </li>
                    <li>Configuration layered in a hierarchical fashion to allow for overrides of values in specific cases</li>
                    <li>Hierarchy is based on environment, data center and/or application identification criteria (name, host, port, version)</li>
                </ul>
            </div>
        </div>
        <div id="step10" class="step slide">
            <h3>our solution</h3>
            <img src="images/solution.png" />
            <div class="notes">
                <ul>
                    <li>Store configuration in a centralize location accessible by all applications</li>
                    <li>Apache ZooKeeper provides us with both a centralized service AND hierarchical data storage</li>
                </ul>
            </div>
        </div>
        <div id="step11" class="step slide">
            <h3>ummmm...that's it?</h3>
            <br />
            <br />
            <br />
            <img src="images/lard_lad.jpg" style="display:block;margin-left:auto;margin-right:auto;"/>
            <div class="notes">
                <ul>
                    <li>No!</li>
                    <li>We will dig into the actual solution in a bit, but first, let's take a look at Apache ZooKeeper and some of the related tools that we used as a foundation for our solution</li>
                </ul>
            </div>
        </div>
        <div id="step12" class="step slide">
            <h3>Apache ZooKeeper</h3>
            <div>
                <span>“ZooKeeper is a centralized service for maintaining configuration information, naming, providing distributed synchronization, and providing group services.”</span>
            </div>
            <img src="images/zookeeper_small.gif" style="display:block;margin-left:auto;margin-right:auto;margin-top:50px;width:25%;height:25%" />
            <div class="footer">
                <span>http://zookeeper.apache.org</span>
            </div>
            <div class="notes">
                <ul>
                    <li>An open-source server which enables highly reliable distributed coordination</li>
                    <li>Originally created to provide orchestration between Apache Hadoop instances</li>
                    <li>Grown to focus on providing the items listed in the definition for any distributed system</li>
                </ul>
            </div>
        </div>
        <div id="step13" class="step slide">
            <h3>Apache ZooKeeper</h3>
            <div>
                <span>replicated servers that are organized into an “ensemble”</span>
                <img src="images/zkservice.jpg" style="margin-left:auto;margin-right:auto;margin-top:50px;" />
            </div>
            <div class="footer">
                <span>http://zookeeper.apache.org/doc/trunk/zookeeperOver.html#sc_designGoals</span>
            </div>
            <div class="notes">
                <ul>
                    <li>The ensemble maintains an in-memory image of state</li>
                    <li>Transaction logs and snapshots of data are persisted to disk </li>
                    <li>The ensemble uses an election algorithm to anoint a leader
                        <ul>
                            <li>Leader is responsible for handling all “write” requests</li>
                            <li>With 2n + 1 members, can withstand n failures</li>
                            <li>Recommended that you have at least 5 members in the ensemble, minimum is 3</li>
                        </ul>
                    </li>
                    <li>Clients can connect to any member of the ensemble
                        <ul>
                            <li>Writes are routed to the “leader”</li>
                        </ul>
                    </li>
                </ul>
            </div>
        </div>
        <div id="step14" class="step slide">
            <h3>Apache ZooKeeper</h3>
            <div>
                <span>data model uses hierarchical name spacing</span>
                <img src="images/zknamespace.jpg" style="margin-left:auto;margin-right:auto;margin-top:50px;" />
            </div>
            <div class="footer">
                <div>
                    http://zookeeper.apache.org/doc/trunk/zookeeperOver.html#sc_dataModelNameSpace
                </div>
            </div>
            <div class="notes">
                <ul>
                    <li>Nodes are called “znodes”</li>
                    <li>Similar to a traditional file system
                        <ul>
                            <li>Key difference is that a node can be both a file and a directory (i.e. byte data can be stored at any node, even if it has sub-nodes)</li>
                            <li>ZK also keeps metadata about each node, called “statistics” (created timestamp, edited timestamp, version, etc)</li>
                        </ul>
                    </li>
                    <li>Data is kept in-memory
                        <ul>
                            <li>This is how ZK achieves high throughput and low latency numbers</li>
                        </ul>
                    </li>
                    <li>Changes to nodes can be “watched”, which allows for your application to be notified when data changes at a certain path.</li>
                </ul>
            </div>
        </div>
        <div id="step15" class="step slide">
            <h3>Apache ZooKeeper</h3>
            <div>
                <span>other guarantees:</span>
                <ul>
                    <li>Updates are applied in order</li>
                    <li>No partial write results</li>
                    <li>Consistent view of system data within ensemble</li>
                    <li>Eventual consistency of updates between clients</li>
                </ul>
            </div>
            <div class="notes">
                <ul>
                    <li>ZK manages the consistency of your data for you so you don't have to worry about it </li>
                    <li>This is just a small portion of what ZK provides with regards to orchestration and distributed state management</li>
                </ul>
            </div>
        </div>
        <div id="step16" class="step slide">
            <h3>Apache ZooKeeper</h3>
            <div>
                <span>supports the following client authentication schemes “out of the box”:</span>
                <ul>
                    <li>Digest</li>
                    <li>IP (whitelist/blacklist)</li>
                    <li>SASL</li>
                </ul>
            </div>
            <div class="notes">
                <ul>
                    <li>“Pluggable” authentication support - can create custom implementations</li>
                    <li>Enabled via the ZooKeeper configuration file or system properties</li>
                    <li>Multiple client authentication mechanisms can be enabled (will be applied in order defined by configuration)</li>
                </ul>
            </div>
        </div>
        <div id="step17" class="step slide">
            <h3>Apache ZooKeeper</h3>
            <div>
                <span>access to znodes can be controlled with applied ACL’s</span>
                <ul>
                    <li><strong>CREATE</strong>: you can create a child node</li>
                    <li><strong>READ</strong>: you can get data from a node and list its children.</li>
                    <li><strong>WRITE</strong>: you can set data for a node</li>
                    <li><strong>DELETE</strong>: you can delete a child node</li>
                    <li><strong>ADMIN</strong>: you can set permissions</li>
                </ul>
            </div>
            <div class="notes">
                <ul>
                    <li>Similar to UNIX file access permissions
                        <ul>
                            <li>Key differences:
                                <ul>
                                    <li>ACL is not limited by scope, as no one “owns” a znode.  Instead, it is tied to the authenticated user</li>
                                    <li>ACL’s are not recursive (i.e. it does not apply to any children of the znode -- must be set manually on each child)</li>
                                </ul>
                            </li>
                        </ul>
                    </li>
                    <li>ACL’s can be assigned at the time of creating a znode or at any point afterwards, as long as the authenticated user has “ADMIN” ACL</li>
                </ul>
            </div>
        </div>
        <div id="step18" class="step slide">
            <h3>Apache ZooKeeper</h3>
            <div>
                <span>ships with Java, C, Perl and Python client bindings</span>
                <br />
                <br />
                <br />
                <span style="font-size:18px">information on additional bindings can be found at:
                <br />
                https://cwiki.apache.org/confluence/display/ZOOKEEPER/ZKClientBindings </span>
            </div>
            <div class="notes">
                <ul>
                    <li>Additional bindings include:
                        <ul>
                            <li>Scala</li>
                            <li>C#</li>
                            <li>Node.JS</li>
                            <li>Erlang</li>
                            <li>Haskell</li>
                            <li>Ruby</li>
                            <li>Go</li>
                            <li>Lua</li>
                        </ul>
                    </li>
                </ul>
            </div>
        </div>
        <div id="step19" class="step slide">
            <h3>Apache Curator</h3>
            <img src="images/curator-logo.png" style="float:right" />
            <div>
                <span>the “better” Java ZooKeeper client</span>
                <ul>
                    <li>“Fluent”-style syntax:
                        <code>client.create().forPath(<span class="string">"/head"</span>, <span class="new">new</span> byte[<span class="decimal">0</span>]);</code>
                        <code>client.delete().inBackground().forPath(<span class="string">"/head"</span>);</code>
                        <code>client.create().withMode(CreateMode.<span class="new">EPHEMERAL_SEQUENTIAL</span>)</code>
                        <code>&nbsp;&nbsp;&nbsp;&nbsp;.forPath(<span class="string">"/head/child"</span>, <span class="new">new</span> byte[<span class="decimal">0</span>]);</code>
                        <code>client.getData().watched().inBackground().forPath(<span class="string">"/test"</span>);</code>
                    </li>
                    <br />
                    <li>http://curator.incubator.apache.org/index.html</li>
                </ul>
            </div>
            <div class="notes">
                <ul>
                    <li>A “curator” is a keeper or custodian of a museum or other collection (in other words, a zoo keeper’s boss)</li>
                    <li>Originally created by Netflix, open sourced and given to the Apache Software Foundation to sheppard</li>
                    <li>The Curator project also includes “recipes” for common operations/uses of ZooKeeper (i.e. distributed locking, etc)</li>
                    <li>Much easier to use than the raw Java client driver, thanks to its fluent style
                        <ul>
                            <li>In practice, we found it much easier to deal with exceptions/errors and to get statistics back from znodes</li>
                        </ul>
                    </li>
                </ul>
            </div>
        </div>
        <div id="step20" class="step slide">
            <h3>reading data from ZK with Curator</h3>
            <div>
                <code>client.create().withACL(<span class="new">new</span> Acl(ZooDefs.Perms.<span class="new">READ</span>, </code>
                <code>&nbsp;&nbsp;&nbsp;&nbsp;ZooDefs.Ids.<span class="new">ANYONE_ID_UNSAFE</span>)).forPath(<span class="string">"/path/in/zk"</span>,</code>
                <code>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string">"some data"</span>.getBytes());</code>
                <br />
                <br />
                <code><span class="new">if</span>(client.checkExists().forPath(<span class="string">"/path/in/zk"</span>) != <span class="new">null) {</span></code>
                <code>&nbsp;&nbsp;&nbsp;&nbsp;<span class="new">final byte[]</span> bindingData = client.getData().forPath(<span class="string">"/path/in/zk"</span>);</code>
                <code>}</code>
            </div>
            <div class="notes">
                <ul>
                    <li>Parent directories must exist when creating a znode</li>
                    <li>ACL's can be set at creation time or later after a node has been created</li>
                    <li>Data is retrieved by path</li>
                    <li>Data is stored in ZK as raw bytes</li>
                </ul>
            </div>
        </div>
        <div id="step21" class="step slide">
            <h3>writing data to ZK with Curator</h3>
            <div>
                <code><span class="new">if</span>(client.checkExists().forPath(<span class="string">"/path/in/zk"</span>) != <span class="new">null) {</span></code>
                <code>&nbsp;&nbsp;&nbsp;&nbsp;client.setData().forPath(<span class="string">"/path/in/zk"</span>, <span class="string">"new data"</span>.getBytes());</code>
                <code>}</code>
            </div>
            <div class="notes">
                <ul>
                    <li>Just like with reading, path must exist before writing data to an existing node</li>
                </ul>
            </div>
        </div>
        <div id="step22" class="step slide">
            <h3>watching data changes in ZK with Curator</h3>
            <div>
                <code><span class="new">class</span> WatcherImpl <span class="new">implements</span> CuratorWatcher {</code>
                <code>&nbsp;&nbsp;&nbsp;&nbsp;@Override</code>
                <code>&nbsp;&nbsp;&nbsp;&nbsp;<span class="new">public void</span> process(WatchedEvent event) {</code>
                <code>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;System.out.println(<span class="string">"Processing event for path "</span> +</code>
                <code>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;event.getPath() + <span class="string">"..."</span>);</code>
                <br />
                <code>&nbsp;&nbsp;&nbsp;&nbsp;}</code>
                <br />
                <code>}</code>
                <br />
                <br />
                <code>client.getData().usingWatcher(<span class="new">new</span> WatcherImpl())</code>
                <code>&nbsp;&nbsp;&nbsp;&nbsp;.forPath(<span class="string">"/some/zk/path"</span>);</code>
            </div>
            <div class="notes">
                <ul>
                    <li>Custom watcher gets called when an event happens at the path specified</li>
                    <li>Events include node created, node deleted, node data changed or node children changed</li>
                </ul>
            </div>
        </div>
        <div id="step23" class="step slide">
            <h3>Exhibitor</h3>
            <div>
                <span>a Java-based supervisory system for ZooKeeper that provides:</span>
                <ul>
                    <li>current state of a ZooKeeper server instance</li>
                    <li>periodic backups of data/transactions</li>
                    <li>periodic cleaning of ZooKeeper logs</li>
                    <li>UI for exploring znodes</li>
                    <li>REST API for all of the above</li>
                </ul>
                <br />
                <span>Code available @ https://github.com/Netflix/exhibitor</span>
            </div>
            <div class="notes">
                <ul>
                    <li>Created by Netflix</li>
                    <li>Web-based UI for managing a ZooKeeper instance
                        <ul>
                            <li>Installed on each ZooKeeper server in your ensemble</li>
                            <li>Uses REST interface to talk between Exhibitor instances</li>
                        </ul>
                    </li>
                    <li>Can be used to manage the ZooKeeper configuration files pushed to each instance in the ensemble</li>
                    <li>Verify useful for viewing a read-only copy of the data stored in the znodes</li>
                </ul>
            </div>
        </div>
        <div id="step24" class="step slide">
            <h3>Exhibitor</h3>
            <img src="images/exhibitor.png" style="width:100%;height:100%;"/>
            <div class="notes">
                <ul>
                    <li>Example of the znode tree view in the Exhibitor UI</li>
                    <li>very useful for looking at both the state of your ensemble and what data is currently stored in ZK</li>
                </ul>
            </div>
        </div>
        <div id="step25" class="step slide">
            <h3>what we made</h3>
            <img src="images/makingpancakes.jpg" />
            <div class="notes">
                <ul>
                    <li>Now that we have an overview of ZooKeeper, Curator and Exhibitor, let’s take a look at exactly what we built on top of it</li>
                    <li>Our solution is simple at its core:  applications request configuration from the centralized service (ZooKeeper)</li>
                    <li>Let's start by discussing some of the concepts behind the solution</li>
                </ul>
            </div>
        </div>
        <div id="step26" class="step slide">
            <h3>definition</h3>
            <div>
                <span><span class="definition">con·fig·u·ra·tion</span> - a collection of properties that define a resource used by an application at runtime</span>
            </div>
            <div class="notes">
                <ul>
                    <li>For instance, the properties that defines the values used by a data source, such as connection url, username, password, etc.</li>
                    <li>These properties are grouped together to define the configuration of that data source -- no need to look them up one at a time.</li>
                </ul>
            </div>
        </div>
        <div id="step27" class="step slide">
            <h3>configuration</h3>
            <div>
                <span>stored as JSON documents at each znode in ZooKeeper</span>
                 <br />
                 <br />
                <code>{</code>
                <code>&nbsp;&nbsp;&nbsp;&nbsp;"@type":&nbsp;&nbsp;&nbsp;&nbsp;&lt;POJO class used for serialization to/from JSON&gt;,</code>
                <code>&nbsp;&nbsp;&nbsp;&nbsp;"@creator":&nbsp;&lt;The creator class type responsible for converting</code>
                <code>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;config into object&gt;,</code>
                <code>&nbsp;&nbsp;&nbsp;&nbsp;"username":&nbsp;&lt;the username&gt;,</code>
                <code>&nbsp;&nbsp;&nbsp;&nbsp;"password":&nbsp;&lt;the password&gt;,</code>
                <br />
                <code>&nbsp;&nbsp;&nbsp;&nbsp;...</code>
                <br />
                <code>}</code>
            </div>
            <div class="notes">
                <ul>
                    <li>Descriptive format</li>
                    <li>More compact than XML/less verbose than XML</li>
                    <li>Able to take advantage of JSON parsing libraries to work with data at runtime</li>
                    <li>JavaScript friendly -- better fit for use in our UI</li>
                    <li>We'll talk more in a bit about the @type and @creator metadata fields in this example</li>
                </ul>
            </div>
        </div>
        <div id="step28" class="step slide">
            <h3>ZooKeeper does the heavy lifting</h3>
            <div>
                <span>leverages the directory-like structure of znodes to store hierarchical data:</span>
                <ul class="tree">
                    <li>configs
                        <ul>
                            <li>jdbc
                                <ul>
                                    <li>my-datasource
                                        <ul>
                                            <li>development
                                                <ul>
                                                    <li>dc-east</li>
                                                </ul>
                                            </li>
                                            <li>test
                                                <ul>
                                                    <li>dc-west</li>
                                                </ul>
                                            </li>
                                            <li>production
                                                <ul>
                                                    <li>dc-east</li>
                                                    <li>dc-west</li>
                                                </ul>
                                            </li>
                                        </ul>
                                    </li>
                                </ul>
                            </li>
                        </ul>
                    </li>
                </ul>
            </div>
            <div class="notes">
                <ul>
                    <li>Data stored in each znode may be a full configuration document or partial configuration document</li>
                    <li>Child nodes “override” parent nodes
                        <ul>
                            <li>JSON stored at a child node may include new properties or may re-define a property defined in a parent node</li>
                            <li>If the property is not defined in the child node, the value is inherited from the parent node</li>
                            <li>Prevents duplication of data -- only enter values needed for that specific node</li>
                        </ul>
                    </li>
                    <li>znode paths include the configuration type, name, environment, and data center
                        <ul>
                            <li>type and name are required, others are optional and only needed if there is specific configuration available for those cases</li>
                            <li>Example of this would be to have a different hostname property at different levels in the path, based on environment</li>
                        </ul>
                    </li>
                </ul>
            </div>
        </div>
        <div id="step29" class="step slide">
            <h3>lookup</h3>
            <div>
                <span>request configuration by using the most-specific path available:</span>
                <br />
                <br />
                <br />
                <code>/configs/{category}/{name}/{environment}/{data center}</code>
            </div>
            <div class="notes">
                <ul>
                    <li>Potential full path is always used when requesting configuration</li>
                    <li>Solution walks the path starting at the first node
                        <ul>
                            <li>data stored at the node is put in an accumulator
                            <li>if the next node exists, its data is added to the accumulator, overriding any duplicate entries</li>
                            <li>process repeats until all nodes are visited or a node does not exist from the requested path</li>
                        </ul>
                    </li>
                    <li>There's a problem with this approach:  applications have to be aware of exactly which node in the tree that they want to request</li>
                </ul>
            </div>
        </div>
        <div id="step30" class="step slide">
            <h3>the "a-ha" moment</h3>
            <div>
                <span>separate the configuration definition from its association with an application instance</span>
                <img src="images/bindings_illustration.png" />
            </div>
            <div class="notes">
                <ul>
                    <li>Keep an additional set of data in ZooKeeper that tracks exactly which specific configuration nodes are bound to the particular application</li>
                    <li>Allows for different sets of configurations to be used based on application identification data provided at look up time</li>
                    <li>Added bonus:  we have a way to determine exactly which applications are impacted by a configuration change, what downstream services an application relies on etc
                        <ul>
                            <li>This information is critical to ensuring the safety of changes to the system</li>
                        </ul>
                    </li>
                </ul>
            </div>
        </div>
        <div id="step31" class="step slide">
            <h3>definition</h3>
            <div>
                <span><span class="definition">bind·ing</span> - an association between an application and a specific configuration</span>
            </div>
            <div class="notes">
                <ul>
                    <li>Multiple applications may consume the same configuration -- no need to duplicate the configuration data</li>
                    <li>Duplication of data causes mistakes</li>
                </ul>
            </div>
        </div>
        <div id="step32" class="step slide">
            <h3>binding</h3>
            <div>
                <span>stored as JSON documents at each znode in ZooKeeper</span>
                <br />
                <br />
                <code>"jdbc/rw-database"&nbsp;:&nbsp;{</code>
                <code>&nbsp;&nbsp;&nbsp;&nbsp;"configPath"&nbsp;:&nbsp;"my-rw-datasource"</code>
                <br />
                <code>}</code>
            </div>
            <div class="notes">
                <ul>
                    <li>Similar concept to how configurations are stored, with regards to the hierarchy and override strategy</li>
                    <li>The “name” of the binding is what the application will use to lookup the configuration (more on this in a minute)</li>
                    <li>The “configPath” property is a pointer to the node in the configuration tree that we want to associate with the application
                        <ul>
                            <li>Path may be relative or absolute.  Relative paths assuming the base path used to find the binding as the path to find the configuration.</li>
                        </ul>
                    </li>
                </ul>
            </div>
        </div>
        <div id="step33" class="step slide">
            <h3>ZooKeeper does more heavy lifting</h3>
            <div>
                <span>leverages the directory-like structure of znodes to store hierarchical data:</span>
                <ul class="tree">
                    <li>bindings
                        <ul>
                            <li>development
                                <ul>
                                    <li>dc-east
                                        <ul>
                                            <li>my-application
                                                <ul>
                                                    <li>server1</li>
                                                </ul>
                                            </li>
                                        </ul>
                                    </li>
                                </ul>
                            </li>
                            <li>test
                                <ul>
                                    <li>dc-west
                                        <ul>
                                            <li>my-application</li>
                                        </ul>
                                    </li>
                                </ul>
                            </li>
                            <li>production
                                <ul>
                                    <li>dc-east
                                        <ul>
                                            <li>my-application
                                                <ul>
                                                    <li>&lt;1.2.3</li>
                                                </ul>
                                            </li>
                                        </ul>
                                    </li>
                                    <li>dc-west
                                        <ul>
                                            <li>my-application</li>
                                        </ul>
                                    </li>
                                </ul>
                            </li>
                        </ul>
                    </li>
                </ul>
            </div>
            <div class="notes">
                <ul>
                    <li>Data stored in each znode may be a full collection of bindings or partial set of bindings</li>
                    <li>Child nodes “override” parent nodes</li>
                    <li>znode paths must include the environment, data center and application name
                        <ul>
                            <li>additional nodes include hostname, port and/or version (or combinations thereof)</li>
                            <li>allows for special cases where custom configuration is needed for a sub-set of servers, versions, etc, such as A-B testing</li>
                        </ul>
                    </li>
                </ul>
            </div>
        </div>
        <div id="step34" class="step slide">
            <h3>lookup (reprise)</h3>
            <div>
                <span>request the <strong>application's</strong> bindings:</span>
                <br />
                <br />
                <br />
                <code>/bindings/{environment}/{data center}/{app name}/{hostname|port|version}</code>
            </div>
            <div class="notes">
                <ul>
                    <li>Application uses its identifying data to request the collection of bindings stored in ZooKeeper
                        <ul>
                            <li>IMPORTANT:  application code never directly requests a configuration.</li>
                            <li>An application knows about itself (i.e. its name, hostname, port and version) and can use that data to find out which configurations it is bound to</li>
                        </ul>
                    </li>
                    <li>Binding tree is walked top-down just like with configuration and stops when it visits all nodes or finds a node in the request path that does not exist</li>
                    <li>Bindings are merged just like configurations to take into account overrides</li>
                </ul>
            </div>
        </div>
        <div id="step35" class="step slide">
            <h3>another "a-ha" moment</h3>
            <div>
                <span>create objects from retrieved, merged configuration:</span>
                <br />
                <br />
                <code>javax.sql.DataSource dataSource = (javax.sql.DataSource)</code>
                <code>&nbsp;&nbsp;&nbsp;&nbsp;ConfigProvider.INSTANCE.lookup(<span class="string">"jdbc/my-data-source</span>);</code>
                <br />
                <br />
                <code>javax.mail.Session session = (javax.mail.Session)</code>
                <code>&nbsp;&nbsp;&nbsp;&nbsp;ConfigProvider.INSTANCE.lookup(<span class="string">"mail/my-smtp-server</span>);</code>
            </div>
            <div class="notes">
                <ul>
                    <li>Allows the framework to enforce standards/conventions with regards to implementations/libraries used to consume other services in our enterprise</li>
                    <li>Abstracts all of the details of how the configuration is stored and retrieved so the application doesn't know/doesn't care
                        <ul>
                            <li>Standardized on a well-known Java API - JNDI</li>
                            <li>Makes the framework more flexible and able to modify the underlying implemntation</li>
                        </ul>
                    </li>
                    <li>We saw some of this in action on earlier slides - remember the @type and @creator meta tags and the "name" portion of the binding?</li>
                </ul>
            </div>
        </div>
        <div id="step36" class="step slide">
            <h3>the request</h3>
            <img src="images/request_flow.png" style="width:100%;height:100%" />
            <div class="notes">
                <ul>
                    <li>request looks like a normal JNDI lookup from the application's perspective</li>
                    <li>we keep an in-memory cache of created objects to speed up repeated lookup requests</li>
                    <li>bindings are retrieved based on the application's identifying information
                        <ul>
                            <li>retrieved bindings are scanned for an entry whose "name" property matches the lookup string provided by the application</li>
                            <li>if a match is found, the configuration data is retrieved and merged into a single map and cached on disk as a fail safe
                                <ul>
                                    <li>this fail-safe is used if during a future request, the service cannot be reached (offline/detached mode)</li>
                                </ul>
                            </li>
                        </ul>
                    <li>the merged configuration contains the creator that should be used.  the configuration is passed to the matching creator</li>
                    <li>a configured object is cached and returned to the application, which is none the wiser to the fact that configuration was remotely retrieved</li>
                </ul>
            </div>
        </div>
        <div id="step37" class="step slide">
            <h3>the request in code</h3>
            <div>
                <code><span class="new">public</span> Object lookup(String name) {</code>
                <code>&nbsp;&nbsp;&nbsp;&nbsp;<span class="new">final</span> Context context = new Context(lookupName);</code>
                <code>&nbsp;&nbsp;&nbsp;&nbsp;<span class="new">final</span> List&lt;Command&gt; commands = <span class="new">new</span> ArrayList&lt;Command&gt;();</code>
                <br />
                <br />
                <code>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string">//convert application ID info into a ZK path</span></code>
                <code>&nbsp;&nbsp;&nbsp;&nbsp;commands.add(<span class="new">new</span> BindingPathCommand());</code>
                <code>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string">//retrieve binding set from ZK using binding path </span></code>
                <code>&nbsp;&nbsp;&nbsp;&nbsp;commands.add(<span class="new">new</span> BindingCommand());</code>
                <code>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string">//retrieve the config from ZK based on the data in the binding set</span></code>
                <code>&nbsp;&nbsp;&nbsp;&nbsp;commands.add(<span class="new">new</span> ConfigCommand());</code>
                <br />
                <br />
                <code>&nbsp;&nbsp;&nbsp;&nbsp;<span class="new">final</span> Chain chain = <span class="new">new</span> ChainBase(commands);</code>
                <code>&nbsp;&nbsp;&nbsp;&nbsp;chain.execute(context);</code>
                <code>&nbsp;&nbsp;&nbsp;&nbsp;<span class="new">return</span> ObjectFactory.create(context.getConfig());</code>
                <code>}</code>
            </div>
            <div class="notes">
                <ul>
                    <li>chain of responsiblity pattern</li>
                    <li>allows for easy interjection of steps as the algorithm evolves</li>
                    <li>result of executing the chain is the merged configuration</li>
                    <li>merged configuration is passed to object creator defined in the configuration</li>
                    <li>final result is an object created from the merged configuration</li>
                </ul>
            </div>
        </div>
        <div id="step38" class="step slide">
            <h3>protect the cookie jar</h3>
            <img src="images/cookie_monster.png" style="float:right;width:50%;height:50%" />
            <div>
                <ul>
                    <li>SASL authentication</li>
                    <li>ACL's applied to znodes</li>
                    <li>encryption of sensitive data</li>
                </ul>
            </div>
            <div class="notes">
                <ul>
                    <li>Centralizing our configuration data requires that we be smart about who has access to what
                        <ul>
                            <li>Need to make sure that non-production code does not have access to production systems through configuration, etc</li>
                        </ul>
                    </li>
                    <li>make use of built-in authentication provider and ACL support discussed earlier
                        <ul>
                            <li>SASL auth provider used to identify type of client (application or management)</li>
                            <li>applications have read-only access to ZK data through ACL enforcement</li>
                            <li>tree path traversal restricted by ACL enforcement (dev apps can only read from dev tree, etc)</li>
                        </ul>
                    </li>
                    <li>password fields in JSON data stored in ZK is encrypted at rest and decrypted upon request</li>
                </ul>
            </div>
        </div>
        <div id="step39" class="step slide">
            <h3>problem</h3>
            <div>
                <span><span class="done">&#10003</span> I want to configure my application</span>
            </div>
            <div class="notes">
                <ul>
                    <li>We did one better:  someone else configured it...you simply just connected to the service and got what you needed</li>
                </ul>
            </div>
        </div>
        <div id="step40" class="step slide">
            <h3>problem</h3>
            <div>
                <span><span class="done">&#10003</span> I want to make configuration changes to my application without re-deploying</span>
            </div>
            <div class="notes">
                <ul>
                    <li>The configuration is no longer kept within the application.</li>
                    <li>A simple restart will re-request the created, configured objects from ZK</li>
                    <li>Future expansion - use the "watch" functionality of ZooKeeper to be notified when data changes</li>
                </ul>
            </div>
        </div>
        <div id="step41" class="step slide">
            <h3>problem</h3>
            <div>
                <span><span class="done">&#10003</span> I want to be able to spin up a new instance of an application without having to duplicate its configuration</span>
            </div>
            <div class="notes">
                <ul>
                    <li>If the bindings are the same, nothing has to be done for this to work.</li>
                    <li>You can always define a new, specific binding set if required, but that should be the exception, not the rule</li>
                </ul>
            </div>
        </div>
        <div id="step42" class="step slide">
            <h3>problem</h3>
            <div>
                <span><span class="done">&#10003</span> I want configuration consistency between application instances and different applications</span>
            </div>
            <div class="notes">
                <ul>
                    <li>Separation of configuration definitions from application bindings allows for one common configuration to be shared among applications WITHOUT having to copy and paste into each application's configuration files.</li>
                </ul>
            </div>
        </div>
        <div id="step43" class="step slide">
            <h3>problem</h3>
            <div>
                <span><span class="done">&#10003</span> I want to avoid plain-text passwords in my configuration files</span>
            </div>
            <div class="notes">
                <ul>
                    <li>Passwords are now stored in the remote configuration data in ZooKeeper, and can be encrypted and protected by ACL's</li>
                </ul>
            </div>
        </div>
        <div id="step44" class="step slide">
            <h3>summary</h3>
            <img src="images/fry.jpg" style="float:right;width:70%;height:70%" />
            <div>
                <ul>
                    <li>hierarchical</li>
                    <li>distributed</li>
                    <li>scalable</li>
                    <li>secured</li>
                    <li>tolerant</li>
                </ul>
            </div>
            <div class="notes">
                <ul>
                    <li>code doesn't really do that much -- power is in how the data is stored in ZK</li>
                    <li>power of inheritence reduces the copy and paste pasta of configurations</li>
                    <li>use ZK for what it does well -- data storage, consistency, distribution and fault tolerance</li>
                    <li>enforce good habits, such as access control and data encryption</li>
                </ul>
            </div>
        </div>
        <div id="step45" class="step slide">
            <h3>other thoughs</h3>
            <div>
                <span>possible extensions</span>
                <ul>
                    <li>deployment data</li>
                    <li>dependency detection</li>
                    <li>risk calculation and outage impact</li>
                </ul>
            </div>
            <div class="notes">
                <ul>
                    <li>store deployment information side-by-side with bindings</li>
                    <li>scan binding data to map out dependencies in your enterprise</li>
                    <li>determine the risk of a deployment based on the number of systems that depend on the application</li>
                    <li>when something goes down, quickly determine the reach of the outage with regards to dependencies</li>
                </ul>
            </div>
        </div>
        <div id="step46" class="step slide">
            <h3>additional reading</h3>
            <div>
                <span style="font-size: 18px;"><strong style="color:#ff9900;">Distributed apps with ZooKeeper</strong> - http://blog.cloudera.com/blog/2013/02/how-to-use-apache-zookeeper-to-build-distributed-apps-and-why/</span>
                <br />
                <span style="font-size: 18px;"><strong style="color:#ff9900;">Exhibitor @ Netflix</strong> - http://techblog.netflix.com/2012/04/introducing-exhibitor-supervisor-system.html</span>
                <br />
                <span style="font-size: 18px;"><strong style="color:#ff9900;">ZooKeeper @ Zynga</strong> - http://code.zynga.com/2011/08/updating-thousands-of-configuration-files-in-under-a-second/</span>
                <br />
                <span style="font-size: 18px;"><strong style="color:#ff9900;">Jones</strong> - https://github.com/mwhooker/jones</span>
            </div>
        </div>
        <div id="step47" class="step slide">
            <img src="images/thank_you.png" style="display: block;margin-left: auto;margin-right: auto"/>
            <div style="text-align: center">
                <span><strong>Presentation</strong> @ http://tinyurl.com/o4fdgsk</span>
                <br/>
                <br />
                <span><strong>Contact Me</strong> @ jonathan.pearlin at dealer.com</span>
            </div>
        </div>
    </div>
    <div class="hint">
        <p>Use a spacebar or arrow keys to navigate</p>
    </div>
    <script>
        if ("ontouchstart" in document.documentElement) {
            document.querySelector(".hint").innerHTML = "<p>Tap on the left or right to navigate</p>";
        }
    </script>
    <script src="js/impress.js"></script>
    <script src="js/impressConsole.js"></script>
    <script src="js/impressLayout.js"></script>
    <script>
        impressLayout().init();
        impress().init();
        //impressConsole().init();
        //impressConsole().open(); // If you want them to open automatically
    </script>
</body>

